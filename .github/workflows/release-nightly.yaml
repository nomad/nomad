name: Release Nightly

on:
  # schedule:
  #  # Every night at 4AM UTC+0.
  #  - cron: "0 4 * * *"
  workflow_dispatch:

permissions:
  contents: write

env:
  NIGHTLY_TAG: nightly

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      formatted_date: ${{ steps.release-date.outputs.formatted_date }}
      nightly_tag: ${{ steps.set-tag.outputs.nightly_tag }}
    steps:
      # NOTE: we have to do this because GitHub doesn't support YAML anchors.
      #
      # See https://github.com/actions/runner/issues/1182 for more infos.
      - name: Set tag output
        id: set-tag
        run: echo "nightly_tag=$NIGHTLY_TAG" >> $GITHUB_OUTPUT

      - name: Delete old nightly release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          gh release delete "$NIGHTLY_TAG" --repo "${{ github.repository }}" --yes \
            || echo "No existing release to delete"

      - name: Delete old nightly tag
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          gh api "repos/${{ github.repository }}/git/refs/tags/$NIGHTLY_TAG" \
            --method DELETE \
            || echo "No remote tag to delete"

      - name: Create new nightly tag
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          gh api "repos/${{ github.repository }}/git/refs" \
            --method POST \
            --field ref="refs/tags/$NIGHTLY_TAG" \
            --field sha="${{ github.sha }}"

      - name: Generate release date
        id: release-date
        run: |
          day=$(date '+%-d')
          month=$(date '+%B')
          year=$(date '+%Y')

          # Get ordinal suffix (st, nd, rd, th).
          case $day in
            1|21|31) ordinal_suffix="st" ;;
            2|22) ordinal_suffix="nd" ;;
            3|23) ordinal_suffix="rd" ;;
            *) ordinal_suffix="th" ;;
          esac

          # Format: "January 2nd, 2006".
          formatted_date="${month} ${day}${ordinal_suffix}, ${year}"
          echo "formatted_date=$formatted_date" >> $GITHUB_OUTPUT

  release-nightly:
    needs: setup
    uses: ./.github/workflows/build-and-release.yaml
    secrets: inherit
    with:
      changelog-entry: "Unreleased"
      is-stable: false
      release-name: "Nomad Nightly â€“ ${{ needs.setup.outputs.formatted_date }}"
      release-tag: ${{ needs.setup.outputs.nightly_tag }}
